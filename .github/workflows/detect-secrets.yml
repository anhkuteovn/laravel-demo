name: Detect Secrets (Changed Files Only)

on:
  push:
  pull_request:

jobs:
  detect-secrets:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Get changed files
        id: changed
        run: |
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            --jq '.[].filename' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

        env:
          GH_TOKEN: ${{ github.token }}

      - name: Show changed files
        run: |
          echo "Changed files:"
          echo "$CHANGED_FILES"

      - name: Scan only changed files for secrets
        run: |
          echo "$CHANGED_FILES" | while read file; do
            if [ -f "$file" ]; then
              echo "Scanning: $file"

              # Scan file -> baseline JSON
              detect-secrets scan "$file" > scan.json

              # Count secrets
              count=$(jq '.results | length' scan.json)

              if [ "$count" -gt 0 ]; then
                echo "❌ Secret detected in $file"
                jq '.results' scan.json
                exit 1
              fi
            fi
          done

          echo "✅ No secrets found in changed files."
