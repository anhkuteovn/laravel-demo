name: Detect Secrets (Changed Files Only)

on:
  push:
  pull_request:

jobs:
  detect-secrets:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Get changed files
        id: changed
        run: |
          # Start heredoc
          {
            echo "CHANGED_FILES<<EOF"

            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              echo "Fetching PR changed files..."
              gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
                --jq '.[].filename'
            else
              echo "Fetching push changed files..."
              git fetch --depth=2
              git diff --name-only HEAD~1
            fi

            echo "EOF"
          } >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Show changed files
        run: |
          echo "Changed files:"
          echo "$CHANGED_FILES"

      - name: Scan only changed files for secrets
        run: |
          echo "$CHANGED_FILES" | while read file; do
            [[ -z "$file" ]] && continue

            if [ -f "$file" ]; then
              echo "Scanning: $file"
              detect-secrets scan "$file" > scan.json
              count=$(jq '.results | length' scan.json)

              if [ "$count" -gt 0 ]; then
                echo "❌ Secret detected in $file"
                jq '.results' scan.json
                exit 1
              fi
            fi
          done

          echo "✅ No secrets found in changed files."
